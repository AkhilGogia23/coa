<div class="app-root">
  <div class="card shell">
    <header class="header">
      <div class="logo-circle">C</div>
      <div class="header-text">
        <h1>COA Lookup</h1>
        <p>Search COA & test documents by lot number.</p>
      </div>
    </header>

    <section class="search-section">
      <label for="lot" class="field-label">Lot number</label>
      <div class="search-row">
        <input
          id="lot"
          [(ngModel)]="lotNumber"
          type="text"
          placeholder="e.g. L2025-00123"
          (keyup.enter)="onSearch()"
        />
        <button (click)="onSearch()">Search</button>
      </div>
      <p class="hint">Tip: Use the test lot numbers your client provided.</p>
    </section>

    <section class="status-section">
      <div *ngIf="loading()" class="loader-row">
        <div class="spinner"></div>
        <span>Fetching COA data…</span>
      </div>

      <div *ngIf="error()" class="alert alert-error">
        {{ error() }}
      </div>

      <div *ngIf="!loading() && !error() && !result()">
        <p class="empty-text">
          Enter a lot number above and hit <strong>Search</strong> to see
          results.
        </p>
      </div>
    </section>

    <ng-container *ngIf="result() as r">
      <section class="card summary-card">
        <div class="summary-header">
          <div>
            <h2>{{ r.productName || "Product details" }}</h2>
            <p class="lot-line">
              Lot <span class="lot-pill">{{ r.lotNumber }}</span>
            </p>
          </div>
          <div class="status-pill" [class.status-ok]="r.status === 'Released'">
            {{ r.status || "Unknown status" }}
          </div>
        </div>

        <div class="summary-grid">
          <div>
            <span class="label">SKU</span>
            <span class="value">{{ r.sku || "—" }}</span>
          </div>
          <div>
            <span class="label">Manufactured</span>
            <span class="value">{{ r.manufactureDate || "—" }}</span>
          </div>
          <div>
            <span class="label">Expiry</span>
            <span class="value">{{ r.expiryDate || "—" }}</span>
          </div>
        </div>
      </section>

      <section class="results-section">
        <h3>Ingredients</h3>
        <p class="section-subtitle">Raw materials used in the batch.</p>

        <div *ngIf="!r.results.ingredients?.length" class="empty-chip">
          No ingredient COAs found for this lot.
        </div>

        <div class="coa-card" *ngFor="let item of r.results.ingredients">
          <div class="coa-main">
            <div>
              <h4>{{ item.name }}</h4>
              <p class="coa-lot">Lot: {{ item.lotNumber }}</p>
            </div>
            <span class="pass-pill" [class.pass-pill-fail]="!item.passed">
              {{ item.passed ? "Pass" : "Fail" }}
            </span>
          </div>
    
        </div>
      </section>

      <section class="results-section">
        <h3>Blend</h3>
        <p class="section-subtitle">Intermediate blend test results.</p>

        <div *ngIf="!r.results.blend?.length" class="empty-chip">
          No blend COAs found for this lot.
        </div>

        <div class="coa-card" *ngFor="let item of r.results.blend">
          <div class="coa-main">
            <div>
              <h4>{{ item.name }}</h4>
              <p class="coa-lot">Lot: {{ item.lotNumber }}</p>
            </div>
            <span class="pass-pill" [class.pass-pill-fail]="!item.passed">
              {{ item.passed ? "Pass" : "Fail" }}
            </span>
          </div>
       
        </div>
      </section>

      <section class="results-section">
        <h3>Finished Product</h3>
        <p class="section-subtitle">Final product COAs for the lot.</p>

        <div *ngIf="!r.results.finishedProduct?.length" class="empty-chip">
          No finished product COAs found for this lot.
        </div>

        <div class="coa-card" *ngFor="let item of r.results.finishedProduct">
          <div class="coa-main">
            <div>
              <h4>{{ item.name }}</h4>
              <p class="coa-lot">Lot: {{ item.lotNumber }}</p>
            </div>
            <span class="pass-pill" [class.pass-pill-fail]="!item.passed">
              {{ item.passed ? "Pass" : "Fail" }}
            </span>
          </div>
          <button type="button" class="pdf-link" (click)="downloadCoa(item)">
            Download COA PDF
          </button>
        </div>
      </section>
    </ng-container>

    <footer class="footer">
      Read-only COA lookup – powered by MasterControl &amp; Snowflake (coming).
    </footer>
  </div>
</div>
